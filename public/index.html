<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebRTC Video Stream</title>
  <style>
    video {
      width: 45%;
      margin: 10px;
    }
    #remoteVideo {
      border: 2px solid red;
    }
  </style>
</head>
<body>
  <h2>Video Stream</h2>
  
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>
  
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    
    let localStream;
    let peerConnection;
    let isSharingStream = false; // Flag to indicate if the user is sharing their local stream

    // Get user media (local camera stream) if the user is sharing
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        localStream = stream;
        localVideo.srcObject = stream;
        console.log('Local stream started');
        isSharingStream = true; // User is sharing their stream
        setupWebRTC();
      })
      .catch(err => {
        console.error('Error accessing camera: ', err);
        alert('Error accessing camera. Make sure the browser has camera permissions.');
      });
    
    // WebRTC setup
    function setupWebRTC() {
      console.log('Setting up WebRTC connection...');
      
      peerConnection = new RTCPeerConnection();
      console.log('PeerConnection created');
      
      // If user is sharing, add their stream to the connection
      if (isSharingStream) {
        localStream.getTracks().forEach(track => {
          console.log('Adding track to peer connection:', track);
          peerConnection.addTrack(track, localStream);
        });
      }

      // Listen for remote stream
      peerConnection.ontrack = event => {
        console.log('Received remote stream:', event);
        remoteVideo.srcObject = event.streams[0];
      };
      
      // ICE candidate handling
      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          console.log('Sending ICE candidate:', event.candidate);
          socket.emit('icecandidate', event.candidate);
        }
      };
      
      // Create offer if the user is sharing their stream
      if (isSharingStream) {
        peerConnection.createOffer()
          .then(offer => {
            console.log('Created offer:', offer);
            return peerConnection.setLocalDescription(offer);
          })
          .then(() => {
            console.log('Sending offer to signaling server');
            socket.emit('offer', peerConnection.localDescription);
          })
          .catch(err => {
            console.error('Error creating offer:', err);
          });
      }
    }

    // Handle offer from another client (mobile)
    socket.on('offer', offer => {
      console.log('Received offer from mobile:', offer);
      
      peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
        .then(() => {
          console.log('Remote description set');
          return peerConnection.createAnswer();
        })
        .then(answer => {
          console.log('Created answer:', answer);
          return peerConnection.setLocalDescription(answer);
        })
        .then(() => {
          console.log('Sending answer to signaling server');
          socket.emit('answer', peerConnection.localDescription);
        })
        .catch(err => {
          console.error('Error handling offer:', err);
        });
    });

    // Handle answer from another client (mobile)
    socket.on('answer', answer => {
      console.log('Received answer from mobile:', answer);
      peerConnection.setRemoteDescription(new RTCSessionDescription(answer))
        .catch(err => console.error('Error setting remote description:', err));
    });

    // Handle ICE candidates from other clients
    socket.on('icecandidate', candidate => {
      console.log('Received ICE candidate:', candidate);
      peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
        .catch(err => console.error('Error adding ICE candidate:', err));
    });
  </script>
</body>
</html>
